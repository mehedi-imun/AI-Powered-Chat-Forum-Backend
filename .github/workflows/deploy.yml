name: Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/chat-forum-backend

jobs:
  build-and-deploy:
    name: Build and Deploy All Services
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache,mode=max

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_BACKEND_SSH_KEY }}" > ~/.ssh/backend.pem
          chmod 600 ~/.ssh/backend.pem
          ssh-keyscan -H ${{ secrets.EC2_IP }} >> ~/.ssh/known_hosts

      - name: Deploy All Services on EC2
        env:
          DOCKER_IMAGE: ${{ env.DOCKER_IMAGE }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          RABBITMQ_DEFAULT_USER: ${{ secrets.RABBITMQ_DEFAULT_USER }}
          RABBITMQ_DEFAULT_PASS: ${{ secrets.RABBITMQ_DEFAULT_PASS }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN: ${{ secrets.JWT_EXPIRES_IN }}
          JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET }}
          JWT_REFRESH_EXPIRES_IN: ${{ secrets.JWT_REFRESH_EXPIRES_IN }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
          RATE_LIMIT_WINDOW_MS: ${{ secrets.RATE_LIMIT_WINDOW_MS }}
          RATE_LIMIT_MAX_REQUESTS: ${{ secrets.RATE_LIMIT_MAX_REQUESTS }}
          SITE_URL: ${{ secrets.SITE_URL }}
          SITE_NAME: ${{ secrets.SITE_NAME }}
          GF_SECURITY_ADMIN_USER: ${{ secrets.GF_SECURITY_ADMIN_USER }}
          GF_SECURITY_ADMIN_PASSWORD: ${{ secrets.GF_SECURITY_ADMIN_PASSWORD }}
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
        run: |
          ssh -i ~/.ssh/backend.pem -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_BACKEND_IP }} << 'ENDSSH'
          cd /home/ec2-user/app

          # Create docker-compose.yml
          cat > docker-compose.yml << 'EOF'
          version: '3.9'
          services:
            backend:
              image: ${DOCKER_IMAGE}:latest
              container_name: chat-forum-backend
              restart: unless-stopped
              ports:
                - "5000:5000"
              env_file:
                - .env
              environment:
                - NODE_ENV=production
                - PORT=5000

            rabbitmq:
              image: rabbitmq:3-management-alpine
              container_name: rabbitmq
              restart: unless-stopped
              environment:
                RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
                RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
              ports:
                - "5672:5672"
                - "15672:15672"

            prometheus:
              image: prom/prometheus:latest
              container_name: prometheus
              restart: unless-stopped
              ports:
                - "9090:9090"
              volumes:
                - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml

            grafana:
              image: grafana/grafana:latest
              container_name: grafana
              restart: unless-stopped
              environment:
                GF_SECURITY_ADMIN_USER: ${GF_SECURITY_ADMIN_USER}
                GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD}
              ports:
                - "3000:3000"
              depends_on:
                - prometheus
          EOF

          # Create .env
          cat > .env << 'EOF'
          NODE_ENV=production
          PORT=5000
          DATABASE_URL=${DATABASE_URL}
          REDIS_URL=${REDIS_URL}
          RABBITMQ_URL=amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@localhost:5672
          JWT_SECRET=${JWT_SECRET}
          JWT_EXPIRES_IN=${JWT_EXPIRES_IN}
          JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
          JWT_REFRESH_EXPIRES_IN=${JWT_REFRESH_EXPIRES_IN}
          SMTP_HOST=${SMTP_HOST}
          SMTP_PORT=${SMTP_PORT}
          SMTP_USER=${SMTP_USER}
          SMTP_PASSWORD=${SMTP_PASSWORD}
          EMAIL_FROM=${EMAIL_FROM}
          FRONTEND_URL=${FRONTEND_URL}
          RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS}
          RATE_LIMIT_MAX_REQUESTS=${RATE_LIMIT_MAX_REQUESTS}
          OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
          OPENROUTER_MODEL=${OPENROUTER_MODEL}
          SITE_URL=${SITE_URL}
          SITE_NAME=${SITE_NAME}
          GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER}
          GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD}
          WEBHOOK_SECRET=${WEBHOOK_SECRET}
          EOF

          docker-compose down || true
          docker-compose up -d
          docker image prune -af --filter "until=24h"
          echo " All services deployed!"
          ENDSSH

      - name: Health Check
        run: |
          sleep 30
          curl -f http://${{ secrets.EC2_BACKEND_IP }}:5000/health && echo "Backend healthy"
          curl -s http://${{ secrets.EC2_BACKEND_IP }}:15672 && echo "RabbitMQ running"
          curl -s http://${{ secrets.EC2_BACKEND_IP }}:3000 && echo "Grafana running"
          curl -s http://${{ secrets.EC2_BACKEND_IP }}:9090 && echo "Prometheus running"
