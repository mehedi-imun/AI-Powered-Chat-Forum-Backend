name: Build and Deploy (Backend + RabbitMQ + Infra)

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOCKER_IMAGE_BACKEND: ${{ secrets.DOCKERHUB_USERNAME }}/chat-forum-backend

jobs:
  build-and-deploy:
    name: Build and Deploy to EC2s
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      # ---- Build & Push Backend Image ----
      - name: Build Docker Image (Backend)
        run: docker build -t $DOCKER_IMAGE_BACKEND:latest -f Dockerfile .

      - name: Push Docker Image (Backend)
        run: docker push $DOCKER_IMAGE_BACKEND:latest

      # ---- Deploy Backend + RabbitMQ ----
      - name: Deploy Backend + RabbitMQ
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_BACKEND_IP }}
          username: ubuntu
          key: ${{ secrets.EC2_BACKEND_SSH_KEY }}
          script: |
            set -e
            echo "Deploying backend + RabbitMQ..."
            cd ~/app || mkdir ~/app && cd ~/app

            # Write .env file
            cat <<EOF > .env
            NODE_ENV=production
            PORT=5000
            MONGODB_URI=${{ secrets.MONGODB_URI }}
            REDIS_URL=${{ secrets.REDIS_URL }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            FRONTEND_URL=${{ secrets.FRONTEND_URL }}
            RABBITMQ_URL=amqp://rabbitmq:5672
            PROMETHEUS_URL=http://${{ secrets.EC2_INFRA_IP }}:9090
            EOF

            # Write docker-compose.yml
            cat <<EOF > docker-compose.yml
            version: "3.8"
            services:
              rabbitmq:
                image: rabbitmq:3-management
                container_name: rabbitmq
                ports:
                  - "5672:5672"
                  - "15672:15672"
                restart: always
                networks:
                  - backend-net

              backend:
                image: $DOCKER_IMAGE_BACKEND:latest
                container_name: backend
                env_file:
                  - .env
                ports:
                  - "5000:5000"
                depends_on:
                  - rabbitmq
                restart: always
                networks:
                  - backend-net

            networks:
              backend-net:
                driver: bridge
            EOF

            docker compose pull || true
            docker compose up -d --build
            docker image prune -f

      # ---- Deploy Prometheus + Grafana ----
      - name: Deploy Infra (Prometheus + Grafana)
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_INFRA_IP }}
          username: ubuntu
          key: ${{ secrets.EC2_INFRA_SSH_KEY }}
          script: |
            set -e
            echo "Deploying Prometheus + Grafana..."
            cd ~/infra || mkdir ~/infra && cd ~/infra

            cat <<EOF > docker-compose.yml
            version: "3.8"
            services:
              prometheus:
                image: prom/prometheus:latest
                container_name: prometheus
                volumes:
                  - ./prometheus.yml:/etc/prometheus/prometheus.yml
                ports:
                  - "9090:9090"
                restart: always
                networks:
                  - infra-net

              grafana:
                image: grafana/grafana:latest
                container_name: grafana
                ports:
                  - "3000:3000"
                restart: always
                networks:
                  - infra-net

            networks:
              infra-net:
                driver: bridge
            EOF

            # Create Prometheus config
            cat <<EOF > prometheus.yml
            global:
              scrape_interval: 15s

            scrape_configs:
              - job_name: 'backend'
                static_configs:
                  - targets: ['${{ secrets.EC2_BACKEND_IP }}:5000']
            EOF

            docker compose pull || true
            docker compose up -d --build
            docker image prune -f

      # ---- Health Check ----
      - name: Verify Deployment
        run: |
          echo "Checking services..."
          sleep 10
          curl -f http://${{ secrets.EC2_BACKEND_IP }}:5000 || echo "Backend not responding"
          curl -f http://${{ secrets.EC2_INFRA_IP }}:9090 || echo "Prometheus not responding"
          curl -f http://${{ secrets.EC2_INFRA_IP }}:3000 || echo "Grafana not responding"
