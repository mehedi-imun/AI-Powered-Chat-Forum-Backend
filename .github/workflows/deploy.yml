name: Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/chat-forum-backend

jobs:
  build-and-push:
    name: Build Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache,mode=max

  deploy-backend:
    name: Deploy Backend to EC2
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          cat > ~/.ssh/backend.pem << 'EOF'
          ${{ secrets.EC2_BACKEND_SSH_KEY }}
          EOF
          chmod 600 ~/.ssh/backend.pem
          # Debug: Check key format and fingerprint
          echo "Key first line:"
          head -1 ~/.ssh/backend.pem
          echo "Key last line:"
          tail -1 ~/.ssh/backend.pem
          echo "Key line count:"
          wc -l ~/.ssh/backend.pem
          echo "Key fingerprint:"
          ssh-keygen -lf ~/.ssh/backend.pem || echo "Failed to read key"
          ssh-keyscan -H ${{ secrets.EC2_BACKEND_IP }} >> ~/.ssh/known_hosts

      - name: Deploy backend
        env:
          DOCKER_IMAGE: ${{ env.DOCKER_IMAGE }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          RABBITMQ_DEFAULT_USER: ${{ secrets.RABBITMQ_DEFAULT_USER }}
          RABBITMQ_DEFAULT_PASS: ${{ secrets.RABBITMQ_DEFAULT_PASS }}
          EC2_INFRA_PRIVATE_IP: ${{ secrets.EC2_INFRA_PRIVATE_IP }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN: ${{ secrets.JWT_EXPIRES_IN }}
          JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET }}
          JWT_REFRESH_EXPIRES_IN: ${{ secrets.JWT_REFRESH_EXPIRES_IN }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
          RATE_LIMIT_WINDOW_MS: ${{ secrets.RATE_LIMIT_WINDOW_MS }}
          RATE_LIMIT_MAX_REQUESTS: ${{ secrets.RATE_LIMIT_MAX_REQUESTS }}
          SITE_URL: ${{ secrets.SITE_URL }}
          SITE_NAME: ${{ secrets.SITE_NAME }}
          GF_SECURITY_ADMIN_USER: ${{ secrets.GF_SECURITY_ADMIN_USER }}
          GF_SECURITY_ADMIN_PASSWORD: ${{ secrets.GF_SECURITY_ADMIN_PASSWORD }}
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
        run: |
          ssh -i ~/.ssh/backend.pem -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_BACKEND_IP }} bash << ENDSSH
          
          cd /home/ec2-user/app

          # Create production docker-compose.yml
          cat > docker-compose.yml << 'EOFCOMPOSE'
          services:
            backend:
              image: ${DOCKER_IMAGE}:latest
              container_name: chat-forum-backend
              restart: unless-stopped
              ports:
                - "5000:5000"
              env_file:
                - .env
              environment:
                - NODE_ENV=production
                - PORT=5000
              healthcheck:
                test: ["CMD", "node", "-e", "require('http').get('http://localhost:5000/health')"]
                interval: 30s
                timeout: 10s
                retries: 3
              logging:
                driver: "json-file"
                options:
                  max-size: "10m"
                  max-file: "3"
          EOFCOMPOSE

          # Create .env file (matching your local .env structure)
          cat > .env << 'EOF'
          # Server Configuration
          NODE_ENV=production
          PORT=5000
          FRONTEND_URL=${FRONTEND_URL}

          # Database (MongoDB Atlas - Cloud)
          DATABASE_URL=${DATABASE_URL}

          # JWT Configuration
          JWT_SECRET=${JWT_SECRET}
          JWT_EXPIRES_IN=${JWT_EXPIRES_IN}
          JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
          JWT_REFRESH_EXPIRES_IN=${JWT_REFRESH_EXPIRES_IN}

          # Redis Cloud
          REDIS_URL=${REDIS_URL}

          # RabbitMQ (EC2 Infra Instance)
          RABBITMQ_URL=amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@${EC2_INFRA_PRIVATE_IP}:5672
          RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER}
          RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS}

          # Email (SMTP)
          SMTP_HOST=${SMTP_HOST}
          SMTP_PORT=${SMTP_PORT}
          SMTP_USER=${SMTP_USER}
          SMTP_PASSWORD=${SMTP_PASSWORD}
          EMAIL_FROM=${EMAIL_FROM}

          # Rate Limiting
          RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS}
          RATE_LIMIT_MAX_REQUESTS=${RATE_LIMIT_MAX_REQUESTS}

          # AI (OpenRouter)
          OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
          OPENROUTER_MODEL=${OPENROUTER_MODEL}
          SITE_URL=${SITE_URL}
          SITE_NAME=${SITE_NAME}

          # Grafana
          GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER}
          GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD}
          GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource

          # Webhook
          WEBHOOK_SECRET=${WEBHOOK_SECRET}
          EOF

          # Pull and deploy
          docker pull ${DOCKER_IMAGE}:latest
          docker-compose down || true
          docker-compose up -d
          docker image prune -af --filter "until=24h"

          echo "âœ… Backend deployed!"
          ENDSSH

  deploy-infra:
    name: Deploy Infra Services
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          cat > ~/.ssh/infra.pem << 'EOF'
          ${{ secrets.EC2_INFRA_SSH_KEY }}
          EOF
          chmod 600 ~/.ssh/infra.pem
          # Verify key format
          head -1 ~/.ssh/infra.pem
          ssh-keyscan -H ${{ secrets.EC2_INFRA_IP }} >> ~/.ssh/known_hosts

      - name: Deploy infra services
        env:
          RABBITMQ_DEFAULT_USER: ${{ secrets.RABBITMQ_DEFAULT_USER }}
          RABBITMQ_DEFAULT_PASS: ${{ secrets.RABBITMQ_DEFAULT_PASS }}
          GF_SECURITY_ADMIN_USER: ${{ secrets.GF_SECURITY_ADMIN_USER }}
          GF_SECURITY_ADMIN_PASSWORD: ${{ secrets.GF_SECURITY_ADMIN_PASSWORD }}
          BACKEND_IP: ${{ secrets.EC2_BACKEND_IP }}
        run: |
          ssh -i ~/.ssh/infra.pem -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_INFRA_IP }} bash << ENDSSH

          cd /home/ec2-user/app

          # Create docker-compose.yml
          cat > docker-compose.yml << 'EOFCOMPOSE'
          services:
            rabbitmq:
              image: rabbitmq:3-management-alpine
              container_name: rabbitmq
              restart: unless-stopped
              environment:
                RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
                RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
              ports:
                - "5672:5672"
                - "15672:15672"
              volumes:
                - rabbitmq_data:/var/lib/rabbitmq
              healthcheck:
                test: rabbitmq-diagnostics -q ping
                interval: 10s
                timeout: 5s
                retries: 5
              logging:
                driver: "json-file"
                options:
                  max-size: "10m"
                  max-file: "3"

            prometheus:
              image: prom/prometheus:latest
              container_name: prometheus
              restart: unless-stopped
              command:
                - '--config.file=/etc/prometheus/prometheus.yml'
                - '--storage.tsdb.path=/prometheus'
              ports:
                - "9090:9090"
              volumes:
                - ./prometheus.yml:/etc/prometheus/prometheus.yml
                - prometheus_data:/prometheus
              healthcheck:
                test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
                interval: 30s
                timeout: 10s
                retries: 3
              logging:
                driver: "json-file"
                options:
                  max-size: "10m"
                  max-file: "3"

            grafana:
              image: grafana/grafana:latest
              container_name: grafana
              restart: unless-stopped
              environment:
                GF_SECURITY_ADMIN_USER: ${GF_SECURITY_ADMIN_USER}
                GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD}
                GF_INSTALL_PLUGINS: grafana-clock-panel,grafana-simple-json-datasource
              ports:
                - "3000:3000"
              volumes:
                - grafana_data:/var/lib/grafana
              depends_on:
                - prometheus
              healthcheck:
                test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
                interval: 30s
                timeout: 10s
                retries: 3
              logging:
                driver: "json-file"
                options:
                  max-size: "10m"
                  max-file: "3"

          volumes:
            rabbitmq_data:
            prometheus_data:
            grafana_data:
          EOFCOMPOSE

          # Create prometheus.yml
          cat > prometheus.yml << EOFPROM
          global:
            scrape_interval: 15s
          scrape_configs:
            - job_name: 'prometheus'
              static_configs:
                - targets: ['localhost:9090']
            - job_name: 'backend'
              metrics_path: '/metrics'
              static_configs:
                - targets: ['${BACKEND_IP}:5000']
          EOFPROM

          # Create .env
          cat > .env << 'EOF'
          RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER}
          RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS}
          GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER}
          GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD}
          EOF

          docker-compose down || true
          docker-compose up -d
          docker image prune -af --filter "until=24h"

          echo "âœ… Infra services deployed!"
          ENDSSH

  health-check:
    name: Health Check
    needs: [deploy-backend, deploy-infra]
    runs-on: ubuntu-latest

    steps:
      - name: Wait for services
        run: sleep 30

      - name: Check backend
        run: |
          curl -f http://${{ secrets.EC2_BACKEND_IP }}:5000/health || exit 1
          echo "âœ… Backend healthy"

      - name: Check services
        run: |
          curl -s http://${{ secrets.EC2_INFRA_IP }}:15672 && echo "âœ… RabbitMQ running"
          curl -s http://${{ secrets.EC2_INFRA_IP }}:3000 && echo "âœ… Grafana running"
          curl -s http://${{ secrets.EC2_INFRA_IP }}:9090 && echo "âœ… Prometheus running"

      - name: Summary
        run: |
          echo "ðŸš€ Deployed!"
          echo "Backend: http://${{ secrets.EC2_BACKEND_IP }}:5000"
          echo "RabbitMQ: http://${{ secrets.EC2_INFRA_IP }}:15672"
          echo "Grafana: http://${{ secrets.EC2_INFRA_IP }}:3000"
          echo "Prometheus: http://${{ secrets.EC2_INFRA_IP }}:9090"
