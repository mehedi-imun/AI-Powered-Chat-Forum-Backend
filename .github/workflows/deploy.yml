name: Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/chat-forum-backend

jobs:
  build-and-deploy:
    name: Build and Deploy All Services
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache,mode=max

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_KEY_BASE64 }}" | base64 --decode > ~/.ssh/backend.pem
          chmod 600 ~/.ssh/backend.pem
          ssh-keyscan -H ${{ secrets.EC2_IP }} >> ~/.ssh/known_hosts

      - name: Deploy All Services on EC2
        env:
          DOCKER_IMAGE: ${{ env.DOCKER_IMAGE }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          RABBITMQ_DEFAULT_USER: ${{ secrets.RABBITMQ_DEFAULT_USER }}
          RABBITMQ_DEFAULT_PASS: ${{ secrets.RABBITMQ_DEFAULT_PASS }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_MODEL: ${{ secrets.OPENROUTER_MODEL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_EXPIRES_IN: ${{ secrets.JWT_EXPIRES_IN }}
          JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET }}
          JWT_REFRESH_EXPIRES_IN: ${{ secrets.JWT_REFRESH_EXPIRES_IN }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          EMAIL_FROM: ${{ secrets.EMAIL_FROM }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
          RATE_LIMIT_WINDOW_MS: ${{ secrets.RATE_LIMIT_WINDOW_MS }}
          RATE_LIMIT_MAX_REQUESTS: ${{ secrets.RATE_LIMIT_MAX_REQUESTS }}
          SITE_URL: ${{ secrets.SITE_URL }}
          SITE_NAME: ${{ secrets.SITE_NAME }}
          GF_SECURITY_ADMIN_USER: ${{ secrets.GF_SECURITY_ADMIN_USER }}
          GF_SECURITY_ADMIN_PASSWORD: ${{ secrets.GF_SECURITY_ADMIN_PASSWORD }}
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
        run: |
          ssh -i ~/.ssh/backend.pem -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_IP }} bash << 'ENDSSH'
          set -e

          cd /home/ec2-user/app

          # Create .env file
          cat > .env << 'EOFENV'
          NODE_ENV=production
          PORT=5000
          DATABASE_URL=${DATABASE_URL}
          REDIS_URL=${REDIS_URL}
          RABBITMQ_URL=amqp://${RABBITMQ_DEFAULT_USER}:${RABBITMQ_DEFAULT_PASS}@localhost:5672
          JWT_SECRET=${JWT_SECRET}
          JWT_EXPIRES_IN=${JWT_EXPIRES_IN}
          JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
          JWT_REFRESH_EXPIRES_IN=${JWT_REFRESH_EXPIRES_IN}
          SMTP_HOST=${SMTP_HOST}
          SMTP_PORT=${SMTP_PORT}
          SMTP_USER=${SMTP_USER}
          SMTP_PASSWORD=${SMTP_PASSWORD}
          EMAIL_FROM=${EMAIL_FROM}
          FRONTEND_URL=${FRONTEND_URL}
          RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS}
          RATE_LIMIT_MAX_REQUESTS=${RATE_LIMIT_MAX_REQUESTS}
          OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
          OPENROUTER_MODEL=${OPENROUTER_MODEL}
          SITE_URL=${SITE_URL}
          SITE_NAME=${SITE_NAME}
          GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER}
          GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD}
          WEBHOOK_SECRET=${WEBHOOK_SECRET}
          EOFENV

          # Create monitoring directory
          mkdir -p monitoring

          # Create prometheus config
          cat > monitoring/prometheus.yml << 'EOFPROM'
          global:
            scrape_interval: 15s
            evaluation_interval: 15s

          scrape_configs:
            - job_name: 'prometheus'
              static_configs:
                - targets: ['localhost:9090']

            - job_name: 'backend'
              static_configs:
                - targets: ['backend:5000']
              metrics_path: '/metrics'
          EOFPROM

          # Create docker-compose.yml
          cat > docker-compose.yml << 'EOFCOMPOSE'
          services:
            backend:
              image: ${DOCKER_IMAGE}:latest
              container_name: chat-forum-backend
              restart: unless-stopped
              ports:
                - "5000:5000"
              env_file:
                - .env
              environment:
                - NODE_ENV=production
                - PORT=5000
              healthcheck:
                test: ["CMD", "node", "-e", "require('http').get('http://localhost:5000/health')"]
                interval: 30s
                timeout: 10s
                retries: 3
              logging:
                driver: "json-file"
                options:
                  max-size: "10m"
                  max-file: "3"

            rabbitmq:
              image: rabbitmq:3-management-alpine
              container_name: rabbitmq
              restart: unless-stopped
              environment:
                RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
                RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
              ports:
                - "5672:5672"
                - "15672:15672"
              volumes:
                - rabbitmq_data:/var/lib/rabbitmq
              healthcheck:
                test: ["CMD", "rabbitmq-diagnostics", "ping"]
                interval: 30s
                timeout: 10s
                retries: 3
              logging:
                driver: "json-file"
                options:
                  max-size: "10m"
                  max-file: "3"

            prometheus:
              image: prom/prometheus:latest
              container_name: prometheus
              restart: unless-stopped
              ports:
                - "9090:9090"
              volumes:
                - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
                - prometheus_data:/prometheus
              command:
                - '--config.file=/etc/prometheus/prometheus.yml'
                - '--storage.tsdb.path=/prometheus'
              logging:
                driver: "json-file"
                options:
                  max-size: "10m"
                  max-file: "3"

            grafana:
              image: grafana/grafana:latest
              container_name: grafana
              restart: unless-stopped
              environment:
                GF_SECURITY_ADMIN_USER: ${GF_SECURITY_ADMIN_USER}
                GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD}
                GF_INSTALL_PLUGINS: grafana-clock-panel,grafana-simple-json-datasource
              ports:
                - "3000:3000"
              volumes:
                - grafana_data:/var/lib/grafana
              depends_on:
                - prometheus
              logging:
                driver: "json-file"
                options:
                  max-size: "10m"
                  max-file: "3"

          volumes:
            rabbitmq_data:
            prometheus_data:
            grafana_data:
          EOFCOMPOSE

          # Pull latest image and deploy
          docker pull ${DOCKER_IMAGE}:latest
          docker-compose down || true
          docker-compose up -d
          docker image prune -af --filter "until=24h"
          echo "✅ All services deployed!"
          ENDSSH

      - name: Health Check
        run: |
          sleep 30
          curl -f http://${{ secrets.EC2_IP }}:5000/health && echo "✅ Backend healthy"
          curl -s http://${{ secrets.EC2_IP }}:15672 && echo "✅ RabbitMQ running"
          curl -s http://${{ secrets.EC2_IP }}:3000 && echo "✅ Grafana running"
          curl -s http://${{ secrets.EC2_IP }}:9090 && echo "✅ Prometheus running"